# Event Impact Model

A research-style pipeline that links SEC filing events (8-K / 10-Q / 10-K) to subsequent price impact:
- Build a universe from SEC company tickers
- Download daily prices (Stooq)
- Download EDGAR submission metadata (acceptedDateTime)
- Map events to an effective NYSE trading date
- Run a market-model event study (AR/CAR/CAAR + pretrend)
- Build a model dataset (pre-event features → post-event CAR label)
- Train baselines + LightGBM with walk-forward CV
- Backtest costed quantile L/S and a daily portfolio engine
- Generate a Markdown report with plots/tables

> This repo is intentionally MVP-oriented: correctness, reproducibility, and clear artifacts over “maximum alpha”.

---

## Project structure

```
configs/
  base.yaml
data/
  raw/           # snapshots and raw inputs (universe)
  processed/     # parquet artifacts used by downstream scripts
  cache/         # cached downloads (SEC/Stooq)
reports/
  *.csv          # summaries and tables
  figures/       # plots generated by scripts/11_build_report.py
scripts/
  01_fetch_universe_sec.py
  02_fetch_prices.py
  03_fetch_events.py
  04_event_study_mvp.py
  05_event_study_robustness.py
  06_build_model_dataset.py
  07_train_cv_baselines.py
  07b_train_cv_lgbm.py
  08_backtest_oos.py
  08b_backtest_oos_eventlevel.py
  09_backtest_costed.py
  10_backtest_engine.py
  11_build_report.py
src/event_impact_model/
  utils/
  backtest/
tests/
  fixtures/
  test_*.py
```

---

## Requirements

- Python **3.10+** (recommended: 3.10 or 3.12)
- Works on Windows/macOS/Linux
- Internet access is needed for SEC + Stooq fetch scripts

---

## Quickstart (recommended)

### 1) Create & activate venv

**Windows (PowerShell):**
```bash
python -m venv .venv
.\.venv\Scripts\Activate.ps1
```

**Windows (Git Bash):**
```bash
python -m venv .venv
source .venv/Scripts/activate
```

**macOS/Linux:**
```bash
python -m venv .venv
source .venv/bin/activate
```

### 2) Install

```bash
python -m pip install -U pip
python -m pip install -e ".[dev]"
```

If you see permission issues on Windows, try:
```bash
python -m pip install -U pip --user
```

---

## Reproducible commands (Makefile)

If you have the Makefile in the repo:

```bash
make lint
make test
make pipeline
make backtest
make report
make all
```

If you don’t have GNU make on Windows, you can run the scripts directly (below).

---

## Full pipeline (manual)

Run in this order:

```bash
python scripts/01_fetch_universe_sec.py
python scripts/02_fetch_prices.py
python scripts/03_fetch_events.py
python scripts/04_event_study_mvp.py
python scripts/05_event_study_robustness.py
python scripts/06_build_model_dataset.py
python scripts/07b_train_cv_lgbm.py
python scripts/09_backtest_costed.py
python scripts/10_backtest_engine.py
python scripts/11_build_report.py
```

---

## What each stage produces

### Universe
- `data/raw/universe_sec_YYYY-MM-DD.csv`

### Prices
- `data/processed/prices.parquet`

### Events
- `data/processed/events.parquet`

### Event study (market model)
- `data/processed/event_study_events.parquet`
- `data/processed/event_study_ar.parquet`
- `reports/event_study_summary.csv`

### Robustness
- `reports/event_study_robustness.csv`

### Model dataset
- `data/processed/model_dataset.parquet`

### Models
- Ridge baseline: `data/processed/oos_predictions.parquet`, `data/processed/cv_metrics.csv`
- LightGBM: `data/processed/oos_predictions_lgbm.parquet`, `data/processed/cv_metrics_lgbm.csv`

### Backtests
- Costed event-level:  
  - `reports/backtest_costed_eventlevel_overall.csv`  
  - `reports/backtest_costed_eventlevel_monthly.csv`  
  - `reports/backtest_costed_sensitivity.csv` (robustness grid)
- Portfolio engine:  
  - `reports/backtest_engine_daily.csv`  
  - `reports/backtest_engine_summary.csv`

### Report
- `reports/REPORT.md`
- `reports/figures/*.png`

---

## Configuration

Primary configuration is in `configs/base.yaml`:

- Universe size (`max_tickers`)
- Price provider and start date
- EDGAR forms (8-K, 10-Q, 10-K)
- Paths (raw/processed/cache)
- SEC user agent

**Important:** SEC requires a proper user agent string (Name + email).

---

## Notes on methodology

### Event time → trading date
- SEC provides `acceptanceDateTime` (UTC).
- Converted to US/Eastern.
- Bucketed into: `premarket`, `intraday`, `afterhours`.
- Mapped to an **effective NYSE trade date** (accounting for weekends/holidays).

### Event study (MVP)
- Close-to-close returns.
- Market model vs SPY.
- Estimation window: `[-120, -21]`
- Event window: `[-10, +5]`
- Output: AR/CAR/CAAR
- Pretrend check: CAR on negative taus
- Robustness: subgroup tests + BH FDR correction.

### Modeling
- Label: CAR `[+1, +5]`
- Pre-event features only (momentum/vol/liquidity proxies + event meta)
- Walk-forward CV with embargo (purged-style guardrail)

### Backtesting
- Cost model: turnover-based bps
- Event-level pairing backtest for MVP interpretation
- Daily portfolio engine with constraints (name cap, max positions, gross target)
- Optional vol targeting

---

## Testing & quality

```bash
ruff check .
ruff format .
pytest -q
```

---

## Troubleshooting

### Parquet read error (missing engine)
If you see:
> “Unable to find a usable engine; tried using: 'pyarrow', 'fastparquet'”

Install pyarrow:
```bash
python -m pip install pyarrow
```

### NumPy C-extension import error on Windows
This usually indicates version mismatch (e.g., wrong wheel for your Python).
Fix by recreating the venv and reinstalling, or pin compatible versions:
```bash
python -m pip uninstall -y numpy pandas
python -m pip install "numpy==1.26.4" "pandas==2.2.3" pyarrow
```

### SEC rate limits / blocks
- Ensure `user_agent` in `configs/base.yaml` is compliant.
- Slow down requests if needed (sleep already included in scripts).

---

## License
Add a license if you plan to publish this repo publicly.
