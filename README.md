# Event Impact Model

A reproducible research pipeline that turns SEC filing events into an out-of-sample, costed long/short signal.

This repository is MVP-oriented: correctness, leakage guards, and reproducible artifacts over complexity.

## What it does
- Builds a universe snapshot from SEC company tickers
- Downloads daily prices (Stooq) plus benchmark (SPY)
- Downloads EDGAR submission metadata and timestamps events
- Maps events to an effective NYSE trade date (premarket / intraday / afterhours)
- Runs an event study (AR/CAR/CAAR) with pre-trend checks and FDR for subgroup tests
- Trains baselines and LightGBM using walk-forward CV with purge/embargo guardrails
- Runs a costed backtest and a simple daily portfolio engine (delay, horizon, limits, optional vol targeting)
- Runs robustness sanity checks (label shuffles / subsamples)
- Generates an autogenerated report (`reports/REPORT.md`) with figures and tables

## Repository structure
```
.github/workflows/        # CI
configs/                  # YAML configs
data/
  raw/                    # snapshots (universe) and raw inputs
  processed/              # parquet artifacts used downstream
  cache/                  # cached downloads (SEC / Stooq)
reports/
  figures/                # plots generated by the report script
scripts/                  # pipeline entrypoints (01..14)
src/event_impact_model/   # library code (utils, cv, backtest, etc.)
tests/                    # unit + smoke tests (fixtures)
```

## Requirements
- Python 3.10+
- Internet access required for the full pipeline (SEC + Stooq)
- Offline CI smoke tests use fixtures only

## Setup

Create and activate a virtual environment.

**Windows (PowerShell)**
```bash
python -m venv .venv
.\.venv\Scripts\Activate.ps1
```

**Windows (Git Bash)**
```bash
python -m venv .venv
source .venv/Scripts/activate
```

**macOS/Linux**
```bash
python -m venv .venv
source .venv/bin/activate
```

Install:
```bash
python -m pip install -U pip
python -m pip install -e ".[dev]"
```

## Configuration
Primary configuration lives in `configs/base.yaml`:
- universe size (max_tickers)
- price provider and start date
- EDGAR forms and SEC user agent
- paths (raw/processed/cache)

SEC requires a proper user agent string (name + email).

## Run: full pipeline (network required)

Run in this order:

```bash
python scripts/01_fetch_universe_sec.py
python scripts/02_fetch_prices.py
python scripts/03_fetch_events.py
python scripts/04_event_study_mvp.py
python scripts/05_event_study_robustness.py
python scripts/06_build_model_dataset.py
python scripts/07_train_cv_baselines.py
python scripts/07b_train_cv_lgbm.py
python scripts/09_backtest_costed.py
python scripts/10_backtest_engine.py

# Robustness (offline-capable after artifacts exist)
python scripts/12_robustness_sanity.py
python scripts/13_robustness_subsamples.py
python scripts/14_robustness_within_day_shuffle.py

python scripts/11_build_report.py
```

## Run: one-command runner (recommended on Windows)

If you use Windows and do not have GNU make installed, use:

```bash
python scripts/run_all.py
```

## Run: offline smoke (fixtures only)

```bash
pytest -q tests/test_smoke_e2e.py
python scripts/11_build_report.py
```

## Outputs

### Core artifacts
- `data/raw/universe_sec_YYYY-MM-DD.csv`
- `data/processed/prices.parquet`
- `data/processed/events.parquet`
- `data/processed/event_study_events.parquet`
- `data/processed/event_study_ar.parquet`
- `data/processed/model_dataset.parquet`

### Event study
- `reports/event_study_summary.csv`
- `reports/event_study_robustness.csv`

### Modeling
- Baselines:
  - `data/processed/oos_predictions.parquet`
  - `data/processed/cv_metrics.csv`
- LightGBM:
  - `data/processed/oos_predictions_lgbm.parquet`
  - `data/processed/cv_metrics_lgbm.csv`

### Backtests
- Costed event-level:
  - `reports/backtest_costed_eventlevel_overall.csv`
  - `reports/backtest_costed_eventlevel_monthly.csv`
  - `reports/backtest_costed_sensitivity.csv`
- Portfolio engine:
  - `reports/backtest_engine_daily.csv`
  - `reports/backtest_engine_summary.csv`
  - `reports/backtest_engine_daily_vt10.csv`
  - `reports/backtest_engine_summary_vt10.csv`
  - `reports/backtest_engine_sensitivity.csv`

### Robustness (sanity checks)
- `reports/robustness_sanity.csv`
- `reports/robustness_subsamples.csv`
- `reports/robustness_within_day_shuffle.csv`

### Autogenerated report
- `reports/REPORT.md`
- `reports/figures/*.png`

## Quality checks
```bash
ruff check .
ruff format --check .
pytest -q
```

## Notes on methodology

### Event timestamping and alignment
- SEC provides `acceptanceDateTime` in UTC.
- Converted to US/Eastern and bucketed into:
  - premarket
  - intraday
  - afterhours
- Mapped to an effective NYSE trade date using an exchange calendar.

### Event study (MVP)
- Daily close-to-close returns.
- Market model versus SPY.
- Estimation window: [-120, -21] trading days.
- Event window: [-10, +5] trading days.
- Includes a pre-trend check and subgroup testing with BH-FDR.

### Modeling
- Label: CAR[+1, +5].
- Features are computed pre-event only.
- Walk-forward CV with purge/embargo guardrails.

### Backtesting
- Cross-sectional long/short selection per formation date.
- Configurable execution delay and holding horizon.
- Turnover-based proportional costs.
- Constraints: max positions, name cap, gross target.
- Optional portfolio vol targeting.

## License
MIT License. See `LICENSE`.
